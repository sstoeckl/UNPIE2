<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>UNPIE2 – Case 8m</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module" src="https://webr.r-wasm.org/latest/webr.mjs"></script>

<style>
  html,body{margin:0}
  body{font-family:system-ui,Segoe UI,Arial,sans-serif;color:#111}
  .wrap{max-width:1100px;margin:0 auto;padding:8px 12px}
  .title{text-align:center;margin:6px 0 10px;font-size:1.1rem}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:12px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .panel{border:1px solid #e8e8e8;border-radius:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .left{padding:10px}
  .group{border:1px solid #ddd;border-radius:10px;padding:10px;margin-bottom:10px}
  .group h3{margin:0 0 8px;font-size:1rem}
  .row{display:flex;align-items:center;gap:.8rem}
  .row+.row{margin-top:8px}
  .val{width:7rem;text-align:right;color:#666;font-variant-numeric:tabular-nums}
  input[type=range]{width:100%}
  button{padding:.55rem .9rem;border:0;border-radius:10px;background:#eee;cursor:pointer}
  .right{padding:10px;display:flex;flex-direction:column;gap:10px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .chip{background:#f7f7f9;border:1px solid #e7e7ea;border-radius:999px;padding:.35rem .7rem;font-variant-numeric:tabular-nums}
  .chartWrap{height:420px}
  .legend{display:flex;gap:1rem;justify-content:center;margin-top:6px;color:#666;font-size:.92rem;flex-wrap:wrap}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:.35rem;vertical-align:middle}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">App 8: Real yearly spending financed by given (real) yearly savings</div>

  <div class="grid">
    <!-- LEFT -->
    <div class="panel left">
      <div class="group">
        <h3>Yearly (real) savings payments</h3>
        <div class="row">
          <label for="pmt" style="flex:1">Payment per year</label>
          <input id="pmt" type="range" min="0" max="50000" step="100" value="1000">
          <div class="val" id="pmtLabel">1,000</div>
        </div>
      </div>

      <div class="group">
        <h3>Time horizon for savings (years)</h3>
        <div class="row">
          <label for="nSave" style="flex:1">Years</label>
          <input id="nSave" type="range" min="1" max="50" step="1" value="35">
          <div class="val" id="nSaveLabel">35</div>
        </div>
      </div>

      <div class="group">
        <h3>Time horizon for spending (years)</h3>
        <div class="row">
          <label for="nSpend" style="flex:1">Years</label>
          <input id="nSpend" type="range" min="1" max="50" step="1" value="30">
          <div class="val" id="nSpendLabel">30</div>
        </div>
      </div>

      <div class="group">
        <h3>Rates</h3>
        <div class="row">
          <label for="rate" style="flex:1">Interest rate r</label>
          <input id="rate" type="range" min="0" max="0.08" step="0.0005" value="0.02">
          <div class="val" id="rateLabel">2.00%</div>
        </div>
        <div class="row">
          <label for="infl" style="flex:1">Inflation rate i</label>
          <input id="infl" type="range" min="0" max="0.06" step="0.0005" value="0.01">
          <div class="val" id="inflLabel">1.00%</div>
        </div>
      </div>

      <!-- NEW: Mortality (GM) -->
      <div class="group">
        <h3>Mortality (Gompertz–Makeham)</h3>
        <div class="row">
          <label for="age" style="flex:1">Pension starting age x</label>
          <input id="age" type="range" min="50" max="100" step="1" value="65">
          <div class="val" id="ageLabel">65</div>
        </div>
        <div class="row">
          <label for="lambda" style="flex:1">Accidental death λ</label>
          <input id="lambda" type="range" min="0" max="0.02" step="0.0001" value="0">
          <div class="val" id="lambdaLabel">0.0000</div>
        </div>
        <div class="row">
          <label for="modal" style="flex:1">Modal age m</label>
          <input id="modal" type="range" min="70" max="95" step="0.1" value="82.3">
          <div class="val" id="modalLabel">82.3</div>
        </div>
        <div class="row">
          <label for="disp" style="flex:1">Dispersion b</label>
          <input id="disp" type="range" min="5" max="20" step="0.1" value="11.4">
          <div class="val" id="dispLabel">11.4</div>
        </div>
      </div>

      <button id="compute">Compute</button>
    </div>

    <!-- RIGHT -->
    <div class="panel right">
      <div class="chips">
        <div class="chip"><strong>Yearly savings (real):</strong> <span id="saveOut">—</span></div>
        <div class="chip"><strong>Yearly spending possible (real):</strong> <span id="spendOut">—</span></div>
      </div>

      <div class="chartWrap"><canvas id="bar"></canvas></div>
      <div class="legend">
        <span><span class="dot" style="background:#ff9800"></span>Yearly (real) savings while working</span>
        <span><span class="dot" style="background:#9e9e9e"></span>Yearly (real) spending during retirement (actuarial)</span>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";
  const LOCALE="en-US";
  const fmt=x=>Number(x).toLocaleString(LOCALE,{maximumFractionDigits:2});
  const pct=x=>(Number(x)*100).toLocaleString(LOCALE,{maximumFractionDigits:2})+"%";

  const els = id => document.getElementById(id);
  const pmt=els("pmt"), nSave=els("nSave"), nSpend=els("nSpend"),
        rate=els("rate"), infl=els("infl"),
        age=els("age"), lambda=els("lambda"), modal=els("modal"), disp=els("disp");

  function refreshLabels(){
    els("pmtLabel").textContent=parseFloat(pmt.value).toLocaleString(LOCALE,{maximumFractionDigits:0});
    els("nSaveLabel").textContent=parseInt(nSave.value,10);
    els("nSpendLabel").textContent=parseInt(nSpend.value,10);
    els("rateLabel").textContent=pct(rate.value);
    els("inflLabel").textContent=pct(infl.value);
    els("ageLabel").textContent=parseInt(age.value,10);
    els("lambdaLabel").textContent=parseFloat(lambda.value).toLocaleString(LOCALE,{maximumFractionDigits:4});
    els("modalLabel").textContent=parseFloat(modal.value).toLocaleString(LOCALE,{maximumFractionDigits:1});
    els("dispLabel").textContent=parseFloat(disp.value).toLocaleString(LOCALE,{maximumFractionDigits:1});
  }
  refreshLabels();
  [pmt,nSave,nSpend,rate,infl,age,lambda,modal,disp].forEach(el=>el.addEventListener("input",refreshLabels));

  const ctx=document.getElementById("bar").getContext("2d");
  const bar=new Chart(ctx,{type:"bar",data:{labels:[""],datasets:[
    {label:"Yearly (real) savings while working",  data:[0], backgroundColor:"#ff9800"},
    {label:"Yearly (real) spending during retirement (actuarial)", data:[0], backgroundColor:"#9e9e9e"}
  ]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}},plugins:{legend:{display:true}}}});

  const webr=new WebR();
  await webr.init();
  const rcode = await (await fetch("./r/ucase8m.R")).text();
  await webr.evalR(rcode);

  function unwrap(x){
    if(x==null||typeof x!=="object") return x;
    if(x.type==="list"){ const o={}; (x.names||[]).forEach((k,i)=>o[k]=unwrap(x.values[i])); return o; }
    if(Array.isArray(x.values)) return x.values.length===1?unwrap(x.values[0]):x.values.map(unwrap);
    return x;
  }
  const num=x=>typeof x==="number"?x:(x&&x.values?x.values[0]:Array.isArray(x)?x[0]:NaN);

  async function compute(){
    const expr = `ucase8m(pmt_real_save=${+pmt.value},
                          nper_save=${parseInt(nSave.value,10)},
                          nper_spend=${parseInt(nSpend.value,10)},
                          rate=${+rate.value}, inflation=${+infl.value},
                          x=${parseInt(age.value,10)},
                          lambda=${+lambda.value}, m=${+modal.value}, b=${+disp.value})`;
    const res = await webr.evalR(expr);
    let js = await res.toJs(); if(js&&js.type) js=unwrap(js);

    const saveReal  = num(js.inputs?.pmt_real_save);
    const spendReal = num(js.results?.spend_real_during_retirement);

    document.getElementById("saveOut").textContent  = fmt(saveReal);
    document.getElementById("spendOut").textContent = fmt(spendReal);

    bar.data.datasets[0].data=[saveReal];
    bar.data.datasets[1].data=[spendReal];
    bar.update();
  }

  document.getElementById("compute").addEventListener("click", compute);
  [pmt,nSave,nSpend,rate,infl,age,lambda,modal,disp].forEach(el=>el.addEventListener("change", compute));
  await compute();
</script>
</body>
</html>
