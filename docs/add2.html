<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UNPIE2 – Add 2</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module" src="https://webr.r-wasm.org/latest/webr.mjs"></script>

<style>
  html,body{height:100%;margin:0}
  body{overflow:hidden;font-family:system-ui,Segoe UI,Arial,sans-serif;background:#fff;color:#111}
  .app{height:640px;display:grid;place-items:stretch}
  .wrap{max-width:1150px;margin:0 auto;padding:8px 12px;height:100%;box-sizing:border-box}
  .title{text-align:center;margin:4px 0 6px;font-size:1.15rem}
  .subtitle{text-align:center;margin-bottom:6px;color:#666}
  .grid{display:grid;grid-template-columns:340px 1fr;gap:12px;height:calc(100% - 52px)}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .panel{border:1px solid #e8e8e8;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff}
  .left{padding:10px;overflow:auto}
  .group{border:1px solid #ddd;border-radius:10px;padding:10px;margin-bottom:10px}
  .group h3{margin:0 0 8px;font-size:1rem}
  .row{display:flex;align-items:center;gap:.8rem}
  .row + .row{margin-top:8px}
  .val{width:7rem;text-align:right;color:#666;font-variant-numeric:tabular-nums}
  input[type=range]{width:100%}
  button{padding:.55rem .9rem;border:0;border-radius:10px;background:#eee;cursor:pointer}
  .right{padding:10px;display:flex;flex-direction:column;height:100%;overflow:hidden}
  .badge{display:inline-block;background:#f7f7f9;border-radius:10px;padding:.45rem .7rem;margin-left:.5rem;font-variant-numeric:tabular-nums}
  .chartWrap{flex:1 0 auto;height:360px}
  #line{width:100%;height:100%}
  .kpi{margin-top:6px;text-align:center}
  .kpiTable { border-collapse: separate; border-spacing: 6px; margin: 0 auto; }
  .kpiTable th, .kpiTable td {
    background:#f7f7f9; padding:.45rem .6rem; border-radius:8px;
    font-variant-numeric: tabular-nums; text-align: right; white-space: nowrap;
  }
  .kpiTable th.label { background:#ebedf0; color:#333; text-align:left; }
  .debug{margin-top:6px;background:#f7f7f9;border-radius:10px;padding:6px;overflow:auto;flex:0 0 110px;display:none}
  pre{margin:0;font-size:.82rem}
</style>
</head>
<body>
<div class="app">
  <div class="wrap">
    <div class="title" id="title">App 11: Real yearly savings required to reach minimum desired (real) yearly pension with probability p</div>
    <div class="subtitle">
      <span id="subtitleText">Required (real) yearly savings</span>
      <span class="badge" id="savingsBadge">—</span>
    </div>

    <div class="grid">
      <!-- Controls (links) -->
      <div class="panel left">
        <div class="group">
          <h3 id="gPension">Retirement target (real, yearly)</h3>
          <div class="row">
            <label for="pmin" style="flex:1" id="lPension">Minimum pension</label>
            <input id="pmin" type="range" min="3000" max="60000" step="250" value="12000">
            <div class="val" id="pminLabel">12,000</div>
          </div>
        </div>

        <div class="group">
          <h3 id="gNper">Years to retirement</h3>
          <div class="row">
            <label for="nper" style="flex:1" id="lNper">Years</label>
            <input id="nper" type="range" min="5" max="45" step="1" value="35">
            <div class="val" id="nperLabel">35</div>
          </div>
        </div>

        <div class="group">
          <h3 id="gProb">Probability to reach target</h3>
          <div class="row">
            <label for="prob" style="flex:1" id="lProb">Probability</label>
            <input id="prob" type="range" min="0.5" max="0.99" step="0.005" value="0.80">
            <div class="val" id="probLabel">80.00%</div>
          </div>
        </div>

        <div class="group">
          <h3 id="gRet">Expected (real) return</h3>
          <div class="row">
            <label for="mu" style="flex:1" id="lMu">Expected return</label>
            <input id="mu" type="range" min="0" max="0.10" step="0.0005" value="0.03">
            <div class="val" id="muLabel">3.00%</div>
          </div>
        </div>

        <div class="group">
          <h3 id="gVol">Volatility of expected (real) return</h3>
          <div class="row">
            <label for="vol" style="flex:1" id="lVol">Volatility</label>
            <input id="vol" type="range" min="0" max="0.30" step="0.0005" value="0.08">
            <div class="val" id="volLabel">8.00%</div>
          </div>
        </div>

        <div class="group">
          <h3 id="gConv">Conversion rate at retirement</h3>
          <div class="row">
            <label for="conv" style="flex:1" id="lConv">Conversion rate</label>
            <input id="conv" type="range" min="0.02" max="0.08" step="0.0005" value="0.05">
            <div class="val" id="convLabel">5.00%</div>
          </div>
        </div>

        <button id="compute">Recalculate</button>
      </div>

      <!-- Chart & KPIs (rechts) -->
      <div class="panel right">
        <div class="chartWrap"><canvas id="line"></canvas></div>

        <!-- KPI-Tabelle (Diagnostik): H-Quantile -->
        <div class="kpi">
          <table class="kpiTable" id="kpiTableAdd2">
            <tr id="add2RowHeader">
              <th class="label" id="kHdr">Quantiles of H = C_T × S_T (10–90%):</th>
            </tr>
            <tr id="add2RowVals">
              <th class="label" id="kVals">Values:</th>
            </tr>
          </table>
        </div>

        <div class="debug" id="debugBox"><pre id="debug">Waiting…</pre></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // URL-Params (+ seed)
  const params = new URLSearchParams(location.search);
  const lang   = (params.get("lang")  || "en_EN").toLowerCase();
  const debug  = (params.get("debug") || "FALSE").toUpperCase() === "TRUE";
  const seedQS = params.get("seed");
  const seedVal = seedQS ? parseInt(seedQS,10) : null;

  // i18n (analog add4.html)
  const I18N={
    en_en:{
      title:"App 11: Real yearly savings required to reach minimum desired (real) yearly pension with probability p",
      subtitle:"Required (real) yearly savings",
      gPension:"Retirement target (real, yearly)", lPension:"Minimum pension",
      gNper:"Years to retirement", lNper:"Years",
      gProb:"Probability to reach target", lProb:"Probability",
      gRet:"Expected (real) return", lMu:"Expected return",
      gVol:"Volatility of expected (real) return", lVol:"Volatility",
      gConv:"Conversion rate at retirement", lConv:"Conversion rate",
      btn:"Recalculate",
      kHdr:"Quantiles of H = C_T × S_T (10–90%):",
      kVals:"Values:"
    },
    de_de:{
      title:"App 11: Benötigte reale Jahresersparnis für eine minimale gewünschte reale Jahrespension mit Wahrscheinlichkeit p",
      subtitle:"Benötigte (reale) Jahresersparnis",
      gPension:"Renten-Ziel (real, jährlich)", lPension:"Mindestpension",
      gNper:"Jahre bis zur Pension", lNper:"Jahre",
      gProb:"Wahrscheinlichkeit zur Zielerreichung", lProb:"Wahrscheinlichkeit",
      gRet:"Erwartete (reale) Rendite", lMu:"Erwartete Rendite",
      gVol:"Volatilität der erwarteten (realen) Rendite", lVol:"Volatilität",
      gConv:"Umwandlungssatz bei Pensionseintritt", lConv:"Umwandlungssatz",
      btn:"Neu berechnen",
      kHdr:"Quantile von H = C_T × S_T (10–90%):",
      kVals:"Werte:"
    }
  };
  const T = I18N[lang] || I18N.en_en;

  // Texte setzen (wie add4)
  const ids = ["title","gPension","lPension","gNper","lNper","gProb","lProb","gRet","lMu","gVol","lVol","gConv","lConv","kHdr","kVals"];
  ids.forEach(id => { const el = document.getElementById(id); if (el) el.textContent = T[id]; });
  const subt = document.getElementById("subtitleText"); if (subt) subt.textContent = T.subtitle;
  const btn  = document.getElementById("compute"); if (btn) btn.textContent = T.btn;
  const debugBox = document.getElementById("debugBox"); if (debugBox) debugBox.style.display = debug ? "block" : "none";

  const $ = id => document.getElementById(id);

  // UI Bindings
  const pminEl = $("pmin");
  const nperEl = $("nper");
  const probEl = $("prob");
  const muEl   = $("mu");
  const volEl  = $("vol");
  const convEl = $("conv");

  const pminLbl = $("pminLabel");
  const nperLbl = $("nperLabel");
  const probLbl = $("probLabel");
  const muLbl   = $("muLabel");
  const volLbl  = $("volLabel");
  const convLbl = $("convLabel");

  const badge = $("savingsBadge");
  const dbgEl = $("debug");

  const fmt = (x,opts={}) => Number(x).toLocaleString(undefined,{maximumFractionDigits:0,...opts});
  const pct = x => (parseFloat(x)*100).toFixed(2)+"%";
  const log = x => { if (debug) dbgEl.textContent = typeof x==="string" ? x : JSON.stringify(x,null,2); };

  function refresh(){
    pminLbl.textContent = fmt(pminEl.value, {maximumFractionDigits:0});
    nperLbl.textContent = parseInt(nperEl.value,10);
    probLbl.textContent = pct(probEl.value);
    muLbl.textContent   = pct(muEl.value);
    volLbl.textContent  = pct(volEl.value);
    convLbl.textContent = pct(convEl.value);
  } refresh();

  // Chart (wie add4)
  const COLORS=["#000","#9e9e9e","#1976d2","#ff9800","#7b1fa2","#2e7d32","#c2185b","#455a64","#f57c00","#512da8"];
  const ctx=document.getElementById("line").getContext("2d");
  const line=new Chart(ctx,{type:"line",data:{labels:[],datasets:[]},
    options:{
      responsive:true,maintainAspectRatio:false,
      scales:{ x:{title:{display:true,text:"Years to retirement (t)"}}, y:{beginAtZero:true,title:{display:true,text:"Wealth"},ticks:{callback:v=>fmt(v)}}},
      elements:{point:{radius:2}}, plugins:{legend:{display:false}}
    }});

  function drawPaths(t, paths){
    line.data.labels=t.map(String);
    line.data.datasets=paths.map((row,i)=>({
      label:"path"+(i+1), data:row,
      borderColor:COLORS[i%COLORS.length], backgroundColor:COLORS[i%COLORS.length],
      tension:0.15, fill:false
    }));
    line.update();
  }

  function renderKpiTableAdd2(qvals){
    const hdr = $("add2RowHeader");
    const vls = $("add2RowVals");
    hdr.querySelectorAll("td").forEach(td=>td.remove());
    vls.querySelectorAll("td").forEach(td=>td.remove());
    const probs = ["10%","20%","30%","40%","50%","60%","70%","80%","90%"];
    probs.forEach(p=>{ const td=document.createElement("td"); td.textContent=p; hdr.appendChild(td); });
    (qvals||[]).forEach(v=>{ const td=document.createElement("td"); td.textContent=fmt(v,{maximumFractionDigits:0}); vls.appendChild(td); });
  }

  // WebR
  import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";
  const webr=new WebR();

  // Helper wie in add4
  const getListElem=(obj,name)=>{
    if (!obj) return undefined;
    if (obj[name]!==undefined) return obj[name];
    if (Array.isArray(obj.names)&&Array.isArray(obj.values)){
      const k=obj.names.indexOf(name); if(k>=0) return obj.values[k];
    }
    return undefined;
  };
  const vec=x=>{
    if (!x) return [];
    if (Array.isArray(x)) return x.map(Number);
    if (typeof x==="object" && Array.isArray(x.values)) return x.values.map(Number);
    if (typeof x==="number") return [x];
    return [];
  };

  async function init(){
    await webr.init();
    const code=await (await fetch("./r/uadd2.R")).text();
    await webr.evalR(code);
  }

  async function compute(){
    try{
      refresh();
      const pmin = +pminEl.value,
            nper = parseInt(nperEl.value,10),
            pr   = +probEl.value,
            mu   = +muEl.value,
            sg   = +volEl.value,
            cv   = +convEl.value;

      const r = await webr.evalR(`
        out <- uadd2(
          pension_min=${pmin}, nper=${nper}, prob_ok=${pr},
          mu_real=${mu}, vol_real=${sg}, conv=${cv},
          n_scen=10000, n_show=10,
          seed=${seedVal!==null?seedVal:"NULL"}
        ); out
      `);

      const root=await r.toJs();
      :contentReference[oaicite:1]{index=1}
