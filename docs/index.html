<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pension Finance – Ucase1 (WebR)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:900px;margin:2rem auto;padding:0 1rem}
    h1{font-size:1.4rem;margin-bottom:0.5rem}
    .row{display:flex;gap:1rem;flex-wrap:wrap;margin:0.5rem 0}
    label{display:flex;flex-direction:column;font-size:0.9rem}
    input{padding:0.4rem;border:1px solid #ccc;border-radius:6px;min-width:140px}
    button{padding:0.6rem 1rem;border:0;border-radius:8px;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    pre{background:#f7f7f9;padding:0.8rem;border-radius:8px;overflow:auto}
    .card{border:1px solid #eee;border-radius:12px;padding:1rem}
  </style>
</head>
<body>
  <h1>Pension Finance – Ucase1 (WebR, no server)</h1>

  <div class="card">
    <div class="row">
      <label>Rate (per period)
        <input id="rate" type="number" step="0.0001" value="0.02">
      </label>
      <label>Periods (nper)
        <input id="nper" type="number" step="1" value="10">
      </label>
      <label>Present Value (pv)
        <input id="pv" type="number" step="0.01" value="10000">
      </label>
    </div>
    <div class="row">
      <button id="run">Compute</button>
    </div>
    <div class="row">
      <div><strong>Future Value:</strong> <span id="fv">—</span></div>
    </div>
  </div>

  <h3>Debug output</h3>
  <pre id="out">Waiting…</pre>

<script type="module">
  // ===== Minimal helper to show messages in the Debug box
  const out = document.getElementById("out");
  const fvSpan = document.getElementById("fv");
  function log(msg, obj) {
    out.textContent =
      (typeof msg === "string" ? msg : JSON.stringify(msg, null, 2)) +
      (obj ? "\n" + JSON.stringify(obj, null, 2) : "");
  }

  // ===== WebR setup
  import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";
  const webR = new WebR();

  // Convert WebR's {type,names,values} objects into plain JS
  function unwrap(x) {
    if (x == null || typeof x !== "object") return x;
    if (x.type === "list") {
      const o = {};
      (x.names || []).forEach((k, i) => (o[k] = unwrap(x.values[i])));
      return o;
    }
    if (Array.isArray(x.values)) {
      // atomic vectors are wrapped as {values:[...]}
      if (x.values.length === 1) return unwrap(x.values[0]);
      return x.values.map(unwrap);
    }
    return x;
  }

  async function init() {
    try {
      log("Starting WebR…");
      await webR.init();
      // Load your R function file (case‑sensitive path on GitHub Pages)
      const resp = await fetch("./r/ucase1.R");
      if (!resp.ok) throw new Error(`Could not fetch r/ucase1.R (${resp.status})`);
      const code = await resp.text();
      await webR.evalR(code);
      log("WebR ready. ucase1() loaded.");
    } catch (e) {
      log("Init error: " + (e?.message || e));
      throw e;
    }
  }

  async function runOnce() {
    try {
      const rate = parseFloat(document.getElementById("rate").value);
      const nper = parseInt(document.getElementById("nper").value, 10);
      const pv   = parseFloat(document.getElementById("pv").value);

      // Call the R function; returns a WebR object
      const rObj = await webR.evalR(`ucase1(rate=${rate}, nper=${nper}, pv=${pv})`);
      const raw  = await rObj.toJs();
      const js   = unwrap(raw); // -> { ok, inputs:{...}, results:{ fv: ... } }

      const fv = js?.results?.fv;
      if (typeof fv !== "number") {
        log("Unexpected result shape from R:", js);
        fvSpan.textContent = "n/a";
        return;
      }
      fvSpan.textContent = fv.toFixed(2);
      log(js);
    } catch (e) {
      fvSpan.textContent = "n/a";
      log("Run error: " + (e?.message || e));
    }
  }

  document.getElementById("run").addEventListener("click", runOnce);
  await init();
  await runOnce(); // auto-run once on load
</script>
</body>
</html>
