<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>App 1: Future value of a single contribution</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- WebR -->
  <script type="module" src="https://webr.r-wasm.org/latest/webr.mjs"></script>

  <style>
    :root { --bg:#fff; --card:#f7f7f9; --ink:#111; --muted:#666; --accent:#ff9800; --accent2:#9e9e9e; }
    html,body{height:100%}
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    .wrap{max-width:1100px;margin:1.5rem auto;padding:0 1rem}
    h1{font-size:1.3rem;margin:0 0 1rem 0;text-align:center}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:1rem}
    .panel{background:#fff;border:1px solid #e8e8e8;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .left{padding:1rem}
    .group{border:1px solid #ddd;border-radius:10px;padding:0.8rem 0.9rem;margin-bottom:1rem}
    .group h3{margin:0 0 .6rem 0;font-size:1rem}
    .row{display:flex;align-items:center;gap:.8rem;margin:.3rem 0}
    .row label{flex:1; font-size:.92rem}
    .val{width:7rem;text-align:right;font-variant-numeric:tabular-nums;color:var(--muted)}
    input[type=range]{width:100%}
    button{padding:.55rem .9rem;border:0;border-radius:10px;background:#eee;cursor:pointer}
    .right{padding:1rem}
    .stats{display:flex;gap:1rem;justify-content:center;margin:.4rem 0 0.6rem}
    .stat{background:var(--card);border-radius:12px;padding:.5rem .8rem;font-variant-numeric:tabular-nums}
    .legend{display:flex;gap:1rem;justify-content:center;margin-top:.3rem;color:var(--muted);font-size:.92rem}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:.35rem;vertical-align:middle}
    pre{background:var(--card);padding:.7rem;border-radius:10px;overflow:auto}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>App 1: Future value of a single contribution</h1>

    <div class="grid">
      <!-- Controls -->
      <div class="panel left">
        <div class="group">
          <h3>Single contribution</h3>
          <div class="row">
            <label for="pv">Amount</label>
            <input id="pv" type="range" min="1000" max="100000" step="100" value="30400">
            <div class="val" id="pvLabel">30,400</div>
          </div>
        </div>

        <div class="group">
          <h3>Horizon (years)</h3>
          <div class="row">
            <label for="nper">Years</label>
            <input id="nper" type="range" min="1" max="50" step="1" value="35">
            <div class="val" id="nperLabel">35</div>
          </div>
        </div>

        <div class="group">
          <h3>Interest rate</h3>
          <div class="row">
            <label for="rate">Rate (per year)</label>
            <input id="rate" type="range" min="0" max="0.08" step="0.0005" value="0.02">
            <div class="val" id="rateLabel">2.00%</div>
          </div>
        </div>

        <div class="row" style="justify-content:flex-start;margin-top:.6rem">
          <button id="compute">Compute</button>
        </div>
      </div>

      <!-- Chart & KPIs -->
      <div class="panel right">
        <div class="stats">
          <div class="stat"><strong>Initial contribution:</strong> <span id="pvOut">—</span></div>
          <div class="stat"><strong>Future value:</strong> <span id="fvOut">—</span></div>
        </div>
        <canvas id="bar" height="220"></canvas>
        <div class="legend">
          <span><span class="dot" style="background:var(--accent)"></span>Initial contribution</span>
          <span><span class="dot" style="background:var(--accent2)"></span>Future value at T</span>
        </div>

        <h3 style="margin-top:1rem">Debug output</h3>
        <pre id="debug">Waiting…</pre>
      </div>
    </div>
  </div>

  <!-- Main app script -->
  <script type="module">
    // Tiny logger
    const dbg = document.getElementById("debug");
    const log = (x) => dbg.textContent = typeof x === "string" ? x : JSON.stringify(x, null, 2);

    // UI refs
    const rateEl = document.getElementById("rate");
    const nperEl = document.getElementById("nper");
    const pvEl   = document.getElementById("pv");
    const rateLbl= document.getElementById("rateLabel");
    const nperLbl= document.getElementById("nperLabel");
    const pvLbl  = document.getElementById("pvLabel");
    const pvOut  = document.getElementById("pvOut");
    const fvOut  = document.getElementById("fvOut");
    const fmt    = (x, opts={}) => Number(x).toLocaleString(undefined, { maximumFractionDigits: 2, ...opts });

    function refreshLabels(){
      rateLbl.textContent = (parseFloat(rateEl.value)*100).toFixed(2) + "%";
      nperLbl.textContent = parseInt(nperEl.value,10);
      pvLbl.textContent   = fmt(pvEl.value, { maximumFractionDigits: 0 });
    }
    refreshLabels();

    // Chart
    const ctx = document.getElementById("bar").getContext("2d");
    const bar = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["0", "T"],
        datasets: [
          { label: "Initial", data: [0, null], backgroundColor: "#ff9800" },
          { label: "Future",  data: [null, 0], backgroundColor: "#9e9e9e" }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        scales: {
          x: { title: { display: true, text: "Period (t)" } },
          y: { title: { display: true, text: "Value" }, ticks: { callback: v => fmt(v) } }
        },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: c => " " + fmt(c.parsed.y) } }
        }
      },
      plugins: [{
        // draw value labels above bars
        id: "valLabels",
        afterDatasetsDraw(chart, args, pluginOptions) {
          const { ctx } = chart;
          ctx.save(); ctx.textAlign = "center"; ctx.textBaseline = "bottom"; ctx.fillStyle = "#444";
          chart.data.datasets.forEach((ds, idx) => {
            const meta = chart.getDatasetMeta(idx);
            meta.data.forEach((pt, i) => {
              const val = ds.data[i];
              if (val != null) {
                ctx.fillText(fmt(val), pt.x, pt.y - 6);
              }
            });
          });
          ctx.restore();
        }
      }]
    });

    // WebR loader
    import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";
    const webr = new WebR();

    function unwrap(x){
      if (x == null || typeof x !== "object") return x;
      if (x.type === "list") {
        const o = {}; (x.names||[]).forEach((k,i)=>o[k]=unwrap(x.values[i])); return o;
      }
      if (Array.isArray(x.values)) return x.values.length===1 ? unwrap(x.values[0]) : x.values.map(unwrap);
      return x;
    }

    async function init(){
      log("Starting WebR…");
      await webr.init();
      const code = await (await fetch("./r/ucase1.R")).text();
      await webr.evalR(code);
      log("WebR ready. ucase1() loaded.");
    }

    async function compute(){
      try{
        refreshLabels();
        const rate = parseFloat(rateEl.value);
        const nper = parseInt(nperEl.value,10);
        const pv   = parseFloat(pvEl.value);

        const res = await webr.evalR(`ucase1(rate=${rate}, nper=${nper}, pv=${pv})`);
        const js  = unwrap(await res.toJs());

        const fv  = js?.results?.fv;
        if (typeof fv !== "number") throw new Error("Unexpected R result");

        pvOut.textContent = fmt(pv, { maximumFractionDigits: 0 });
        fvOut.textContent = fmt(fv);

        // update bars
        bar.data.datasets[0].data = [pv, null];
        bar.data.datasets[1].data = [null, fv];
        bar.update();

        log(js);
      }catch(e){
        log("Compute error: " + (e?.message || e));
      }
    }

    // Wire up
    document.getElementById("compute").addEventListener("click", compute);
    rateEl.addEventListener("input", compute);
    nperEl.addEventListener("input", compute);
    pvEl.addEventListener("input", compute);

    await init();
    await compute();
  </script>
</body>
</html>
