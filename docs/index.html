<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>App 1: Future value of a single contribution</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* === Coursera-friendly, no-scroll frame === */
    html, body { height: 100%; margin: 0; }
    body { overflow: hidden; font-family: system-ui, Segoe UI, Arial, sans-serif; color:#111; background:#fff; }

    /* Entire app locked to a single viewport height */
    .app { width: 100%; height: 640px; /* <-- change if you want a taller/shorter app */
           display: grid; place-items: stretch; }

    /* Inner layout */
    .wrap { max-width: 1100px; margin: 0 auto; padding: 8px 12px; height: 100%; box-sizing: border-box; }
    .title { text-align: center; margin: 4px 0 8px; font-size: 1.15rem; }

    .grid { display: grid; grid-template-columns: 320px 1fr; gap: 12px; height: calc(100% - 38px); }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    .panel { border:1px solid #e8e8e8; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); background:#fff; }

    /* Left controls: scroll if content exceeds, but the page itself never scrolls */
    .left { padding: 10px; overflow: auto; }
    .group { border:1px solid #ddd; border-radius:10px; padding:10px; margin-bottom:10px; }
    .group h3 { margin:0 0 8px; font-size:1rem; }
    .row { display:flex; align-items:center; gap:.8rem; }
    .row + .row { margin-top: 8px; }
    .val { width:7rem; text-align:right; color:#666; font-variant-numeric: tabular-nums; }
    input[type=range]{ width:100%; }
    button{ padding:.55rem .9rem; border:0; border-radius:10px; background:#eee; cursor:pointer; }

    /* Right: fixed vertical layout, no overflow beyond panel */
    .right { padding: 10px; display:flex; flex-direction: column; height: 100%; overflow: hidden; }
    .stats { display:flex; gap:10px; justify-content:center; margin-bottom: 8px; flex: 0 0 auto; }
    .stat  { background:#f7f7f9; border-radius:10px; padding:.45rem .7rem; font-variant-numeric:tabular-nums; }

    /* Chart area locked in height */
    .chartWrap { flex: 1 0 auto; height: 320px; /* <- fixed chart height */ }
    #bar { width:100%; height:100%; /* CSS height controls canvas size */ }

    .legend { display:flex; gap:1rem; justify-content:center; margin-top:6px; color:#666; font-size:.92rem; flex:0 0 auto; }
    .dot{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:.35rem; vertical-align:middle; }

    /* Debug stays small */
    .debug { margin-top:6px; background:#f7f7f9; border-radius:10px; padding:6px; overflow:auto; flex: 0 0 110px; }
    pre { margin:0; font-size:.82rem; }
  </style>
</head>
<body>
  <div class="app">
    <div class="wrap">
      <div class="title">App 1: Future value of a single contribution</div>

      <div class="grid">
        <!-- Left: controls -->
        <div class="panel left">
          <div class="group">
            <h3>Single contribution</h3>
            <div class="row">
              <label for="pv" style="flex:1">Amount</label>
              <input id="pv" type="range" min="1000" max="100000" step="100" value="30400">
              <div class="val" id="pvLabel">30,400</div>
            </div>
          </div>

          <div class="group">
            <h3>Horizon (years)</h3>
            <div class="row">
              <label for="nper" style="flex:1">Years</label>
              <input id="nper" type="range" min="1" max="50" step="1" value="35">
              <div class="val" id="nperLabel">35</div>
            </div>
          </div>

          <div class="group">
            <h3>Interest rate</h3>
            <div class="row">
              <label for="rate" style="flex:1">Rate (per year)</label>
              <input id="rate" type="range" min="0" max="0.08" step="0.0005" value="0.02">
              <div class="val" id="rateLabel">2.00%</div>
            </div>
          </div>

          <button id="compute" style="margin-top:6px">Compute</button>
        </div>

        <!-- Right: chart/KPIs/debug -->
        <div class="panel right">
          <div class="stats">
            <div class="stat"><strong>Initial:</strong> <span id="pvOut">—</span></div>
            <div class="stat"><strong>Future value:</strong> <span id="fvOut">—</span></div>
          </div>

          <div class="chartWrap">
            <canvas id="bar"></canvas>
          </div>

          <div class="legend">
            <span><span class="dot" style="background:#ff9800"></span>Initial contribution</span>
            <span><span class="dot" style="background:#9e9e9e"></span>Future value at T</span>
          </div>

          <div class="debug">
            <pre id="debug">Waiting…</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- App script -->
  <script type="module">
    // --- Debug helper
    const dbg = document.getElementById("debug");
    const log = x => dbg.textContent = typeof x === "string" ? x : JSON.stringify(x, null, 2);

    // --- UI refs
    const rateEl = document.getElementById("rate");
    const nperEl = document.getElementById("nper");
    const pvEl   = document.getElementById("pv");
    const rateLbl= document.getElementById("rateLabel");
    const nperLbl= document.getElementById("nperLabel");
    const pvLbl  = document.getElementById("pvLabel");
    const pvOut  = document.getElementById("pvOut");
    const fvOut  = document.getElementById("fvOut");
    const fmt    = (x, opts={}) => Number(x).toLocaleString(undefined, { maximumFractionDigits: 2, ...opts });

    function refreshLabels(){
      rateLbl.textContent = (parseFloat(rateEl.value)*100).toFixed(2) + "%";
      nperLbl.textContent = parseInt(nperEl.value,10);
      pvLbl.textContent   = fmt(pvEl.value, { maximumFractionDigits: 0 });
    }
    refreshLabels();

    // --- Chart (fixed-height inside chartWrap)
    const ctx = document.getElementById("bar").getContext("2d");
    const bar = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["0", "T"],
        datasets: [
          { label: "Initial", data: [0, null], backgroundColor: "#ff9800" },
          { label: "Future",  data: [null, 0], backgroundColor: "#9e9e9e" }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,   // <- honors the CSS height
        scales: {
          x: { title: { display: true, text: "Period (t)" } },
          y: { title: { display: true, text: "Value" }, ticks: { callback: v => fmt(v) }, beginAtZero: true }
        },
        plugins: { legend: { display: false } }
      }
    });

    // --- WebR: inline ucase1 (to keep this single-file); feel free to keep it in docs/r/ucase1.R instead
    import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";
    const webr = new WebR();
    function unwrap(x){ if(x==null||typeof x!=="object")return x; if(x.type==="list"){const o={};(x.names||[]).forEach((k,i)=>o[k]=unwrap(x.values[i]));return o;} if(Array.isArray(x.values)) return x.values.length===1?unwrap(x.values[0]):x.values.map(unwrap); return x; }
    async function init(){
      log("Starting WebR…");
      await webr.init();
      const rCode = `
        ucase1 <- function(rate, nper, pv) {
          stopifnot(is.numeric(rate), is.numeric(nper), is.numeric(pv))
          t <- 0:nper
          fv_path <- pv * (1 + rate)^t
          list(ok=TRUE, inputs=list(rate=rate,nper=nper,pv=pv),
               results=list(fv=tail(fv_path,1), t=t, fv_path=fv_path))
        }
      `;
      await webr.evalR(rCode);
      log("WebR ready. ucase1() loaded.");
    }

    async function compute(){
      try{
        refreshLabels();
        const rate = parseFloat(rateEl.value);
        const nper = parseInt(nperEl.value,10);
        const pv   = parseFloat(pvEl.value);

        const res = await webr.evalR(`ucase1(rate=${rate}, nper=${nper}, pv=${pv})`);
        const js  = unwrap(await res.toJs());
        const fv  = js?.results?.fv;
        if (typeof fv !== "number") throw new Error("Unexpected R result");

        pvOut.textContent = fmt(pv, { maximumFractionDigits: 0 });
        fvOut.textContent = fmt(fv);

        bar.data.datasets[0].data = [pv, null];
        bar.data.datasets[1].data = [null, fv];
        bar.update();
        log(js);
      }catch(e){
        log("Compute error: " + (e?.message || e));
      }
    }

    document.getElementById("compute").addEventListener("click", compute);
    rateEl.addEventListener("input", compute);
    nperEl.addEventListener("input", compute);
    pvEl.addEventListener("input", compute);

    await init();
    await compute();
  </script>
</body>
</html>
