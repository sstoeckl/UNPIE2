<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UNPIE2 – Case 14n</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module" src="https://webr.r-wasm.org/latest/webr.mjs"></script>
<style>
  html,body{height:100%;margin:0}
  body{overflow:hidden;font-family:system-ui,Segoe UI,Arial,sans-serif;background:#fff;color:#111}
  .app{height:640px;display:grid;place-items:stretch}
  .wrap{max-width:1100px;margin:0 auto;padding:8px 12px;height:100%;box-sizing:border-box}
  .title{text-align:center;margin:4px 0 8px;font-size:1.15rem}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:12px;height:calc(100% - 38px)}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .panel{border:1px solid #e8e8e8;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff}
  .left{padding:10px;overflow:auto}
  .group{border:1px solid #ddd;border-radius:10px;padding:10px;margin-bottom:10px}
  .group h3{margin:0 0 8px;font-size:1rem}
  .row{display:flex;align-items:center;gap:.8rem}
  .row + .row{margin-top:8px}
  .val{width:7rem;text-align:right;color:#666;font-variant-numeric:tabular-nums}
  input[type=range]{width:100%}
  button{padding:.55rem .9rem;border:0;border-radius:10px;background:#eee;cursor:pointer}
  .right{padding:10px;display:flex;flex-direction:column;height:100%;overflow:hidden}
  .chartWrap{flex:1 0 auto;height:360px}
  #line{width:100%;height:100%}
  .legend{display:flex;gap:1rem;justify-content:center;margin-top:6px;color:#666;font-size:.92rem;flex:0 0 auto;flex-wrap:wrap}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:.35rem;vertical-align:middle}
  .kpis{display:flex;gap:12px;justify-content:center;margin-top:6px;flex:0 0 auto;flex-wrap:wrap}
  .kpi{background:#f7f7f9;border-radius:10px;padding:.45rem .7rem;font-variant-numeric:tabular-nums}
  .debug{margin-top:6px;background:#f7f7f9;border-radius:10px;padding:6px;overflow:auto;flex:0 0 110px;display:none}
  pre{margin:0;font-size:.82rem}
  /* Zentrierter, schmal gepaddeter Außenrahmen, der NICHT fensterbreit wird */
  .app-shell{
    /* Breite: so breit wie die App, aber nie über den Viewport hinaus */
    max-width: 1120px;                 /* ca. .wrap(1100) + je 10–12px Luft */
    width: min(1120px, calc(100% - 16px)); /* auf kleinen Screens näher ran */
    margin: 10px auto;                 /* zentrieren! */
  
    /* Rahmen-Optik */
    border: 1px solid #d9d9df;
    border-radius: 10px;
    background: #fff;
    padding: 6px;                      /* schmaler Rahmen-Padding */
  
    /* Layout: Inhalt + Footer eigene Zeile (kein Überlappen) */
    display: grid;
    grid-template-rows: auto min-content;
    row-gap: 18px;
  
    box-shadow: 0 1px 2px rgba(0,0,0,.04); /* optional, wie Panels */
  }
  
  /* WICHTIG: .wrap darf die Breite nicht wieder verengen/zentrieren */
  .wrap{
    max-width: 100%;                   /* vorher stand hier meist 1100px */
    margin: 0;                         /* keine zusätzliche Zentrierung hier */
  }
  
  /* Falls deine App irgendwo fix auf Höhe gesetzt war: aufheben */
  .app{ height: auto; min-height: 0; }
  
  /* Footer sitzt in der unteren Grid-Zeile, rechtsbündig – niemals Overlay */
  .app-shell__footer{
    justify-self: end;
    align-self: end;
    font-size: .75rem;
    color: #666;
    white-space: nowrap;
  }
  
  /* Responsive Finetuning: auf sehr kleinen Screens noch knapper */
  @media (max-width: 480px){
    .app-shell{
      width: calc(100% - 10px);
      padding: 4px;
      row-gap: 4px;
      border-radius: 8px;
    }
  }
</style>
</head>
<body>
  <div class="app-shell">
<div class="app">
  <div class="wrap">
    <div class="title" id="title">App 14n: Fair conversion rate (real) from Gompertz–Makeham</div>
    <div class="grid">
      <div class="panel left">
        <div class="group">
          <h3 id="gAge">Annuitant age</h3>
          <div class="row">
            <label for="age" style="flex:1" id="lAge">Age (years)</label>
            <input id="age" type="range" min="50" max="100" step="1" value="65">
            <div class="val" id="ageLabel">65</div>
          </div>
        </div>
        <div class="group">
          <h3 id="gRates">Rates</h3>
          <div class="row">
            <label for="rate" style="flex:1" id="lRate">Interest rate r</label>
            <input id="rate" type="range" min="0" max="0.08" step="0.0005" value="0.03">
            <div class="val" id="rateLabel">3.00%</div>
          </div>
          <div class="row">
            <label for="infl" style="flex:1" id="lInfl">Inflation i</label>
            <input id="infl" type="range" min="0" max="0.06" step="0.0005" value="0.01">
            <div class="val" id="inflLabel">1.00%</div>
          </div>
        </div>
        <div class="group">
          <h3 id="gMort">Mortality (Gompertz–Makeham)</h3>
          <div class="row">
            <label for="lambda" style="flex:1" id="lLambda">Accidental λ</label>
            <input id="lambda" type="range" min="0" max="0.02" step="0.0001" value="0">
            <div class="val" id="lambdaLabel">0.0000</div>
          </div>
          <div class="row">
            <label for="modal" style="flex:1" id="lModal">Modal age m</label>
            <input id="modal" type="range" min="70" max="95" step="0.1" value="82.3">
            <div class="val" id="modalLabel">82.3</div>
          </div>
          <div class="row">
            <label for="disp" style="flex:1" id="lDisp">Dispersion b</label>
            <input id="disp" type="range" min="5" max="20" step="0.1" value="11.4">
            <div class="val" id="dispLabel">11.4</div>
          </div>
        </div>
        <button id="compute">Compute</button>
      </div>

      <div class="panel right">
        <div class="chartWrap"><canvas id="line"></canvas></div>
        <div class="legend">
          <span><span class="dot" style="background:#1976d2"></span><span id="legSurv">Survival probability</span></span>
        </div>
        <div class="kpis">
          <div class="kpi"><strong id="kpiConvLbl">Fair conversion rate (real):</strong> <span id="convOut">—</span></div>
          <div class="kpi"><strong id="kpiAnnLbl">Annuity factor (real):</strong> <span id="annOut">—</span></div>
        </div>
        <div class="debug" id="debugBox"><pre id="debug">Waiting…</pre></div>
      </div>
    </div>
  </div>
</div>
  <div class="app-shell__footer">© 2025 by Dr. S. Stöckl</div>
</div>

<script type="module">
  // --- i18n ---------------------------------------------------------------
  const params=new URLSearchParams(location.search);
  const lang=(params.get("lang")||"en").toLowerCase();
  const isDE=lang.startsWith("de");
  const LOCALE=isDE ? "de-DE" : "en-US";

  const I18N={
    "en": {
      title:"App 14n: Fair conversion rate (real) from Gompertz–Makeham",
      gAge:"Annuitant age", lAge:"Age (years)",
      gRates:"Rates", lRate:"Interest rate r", lInfl:"Inflation i",
      gMort:"Mortality (Gompertz–Makeham)", lLambda:"Accidental λ", lModal:"Modal age m", lDisp:"Dispersion b",
      legSurv:"Survival probability",
      kpiConvLbl:"Fair conversion rate (real):",
      kpiAnnLbl:"Annuity factor (real):",
      btn:"Compute",
      xAxis:"Age", yAxis:"Survival"
    },
    "de": {
      title:"App 14n: Faire Umwandlungsrate (real) aus Gompertz–Makeham",
      gAge:"Alter der Rentenbezieher:in", lAge:"Alter (Jahre)",
      gRates:"Sätze", lRate:"Zinssatz r", lInfl:"Inflation i",
      gMort:"Sterblichkeit (Gompertz–Makeham)", lLambda:"Unfallsterblichkeit λ", lModal:"Modales Alter m", lDisp:"Dispersion b",
      legSurv:"Überlebenswahrscheinlichkeit",
      kpiConvLbl:"Faire Umwandlungsrate (real):",
      kpiAnnLbl:"Rentenbarwertfaktor (real):",
      btn:"Berechnen",
      xAxis:"Alter", yAxis:"Überleben"
    }
  };
  const T = I18N[isDE ? "de" : "en"];

  const setText=(id,txt)=>{ const el=document.getElementById(id); if(el) el.textContent=txt; };
  ["title","gAge","lAge","gRates","lRate","lInfl","gMort","lLambda","lModal","lDisp","legSurv","kpiConvLbl","kpiAnnLbl"]
    .forEach(k=>setText(k, T[k]));
  document.getElementById("compute").textContent=T.btn;

  // --- helpers ------------------------------------------------------------
  const fmt=(x,opts={})=>Number(x).toLocaleString(LOCALE,{maximumFractionDigits:4,...opts});
  const fmtPct=(x)=> (Number(x)*100).toLocaleString(LOCALE,{maximumFractionDigits:2}) + "%";
  const debug=(params.get("debug")||"FALSE").toUpperCase()==="TRUE";
  const dbgBox=document.getElementById("debugBox"), dbg=document.getElementById("debug");
  if(debug) dbgBox.style.display="block";
  const log=x=>{ if(debug) dbg.textContent=typeof x==="string"?x:JSON.stringify(x,null,2); };

  // --- UI elements --------------------------------------------------------
  const ageEl=document.getElementById("age"), rateEl=document.getElementById("rate"), inflEl=document.getElementById("infl");
  const lamEl=document.getElementById("lambda"), modalEl=document.getElementById("modal"), dispEl=document.getElementById("disp");
  const ageLbl=document.getElementById("ageLabel"), rateLbl=document.getElementById("rateLabel"), inflLbl=document.getElementById("inflLabel");
  const lamLbl=document.getElementById("lambdaLabel"), modalLbl=document.getElementById("modalLabel"), dispLbl=document.getElementById("dispLabel");
  function refreshLabels(){
    ageLbl.textContent=parseInt(ageEl.value,10).toLocaleString(LOCALE);
    rateLbl.textContent=(parseFloat(rateEl.value)*100).toLocaleString(LOCALE,{maximumFractionDigits:2})+"%";
    inflLbl.textContent=(parseFloat(inflEl.value)*100).toLocaleString(LOCALE,{maximumFractionDigits:2})+"%";
    lamLbl.textContent=parseFloat(lamEl.value).toLocaleString(LOCALE,{maximumFractionDigits:4});
    modalLbl.textContent=parseFloat(modalEl.value).toLocaleString(LOCALE,{maximumFractionDigits:1});
    dispLbl.textContent=parseFloat(dispEl.value).toLocaleString(LOCALE,{maximumFractionDigits:1});
  }
  refreshLabels();

  // --- Chart --------------------------------------------------------------
  const ctx=document.getElementById("line").getContext("2d");
  const line=new Chart(ctx,{type:"line",data:{labels:[],datasets:[]},
    options:{
      responsive:true,maintainAspectRatio:false,
      scales:{
        x:{title:{display:true,text:T.xAxis}},
        y:{beginAtZero:true,max:1,title:{display:true,text:T.yAxis},ticks:{callback:v=>v.toFixed(2)}}
      },
      plugins:{legend:{display:false}}
    }
  });
  function draw(ages, surv){
    line.data.labels = ages.map(a=>String(Math.round(a)));
    line.data.datasets = [{label:T.legSurv, data:surv, fill:false, tension:0.2}];
    line.update();
  }

  // --- WebR bridge --------------------------------------------------------
  import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";
  const webr=new WebR();
  function unwrap(x){
    if(x==null||typeof x!=="object") return x;
    if(x.type==="list"){ const o={}; (x.names||[]).forEach((k,i)=>o[k]=unwrap(x.values[i])); return o; }
    if(Array.isArray(x.values)) return x.values.length===1?unwrap(x.values[0]):x.values.map(unwrap);
    return x;
  }
  const num=x=>typeof x==="number"?x:(x&&x.values?x.values[0]:Array.isArray(x)?x[0]:NaN);
  const arr=x=>Array.isArray(x)?x.map(num):(x&&x.values?x.values.map(num):[]);

  async function init(){
    await webr.init();
    const rCode=await (await fetch("./r/ucase14n.R")).text();
    await webr.evalR(rCode);
  }

  async function compute(){
    try{
      refreshLabels();
      const x = parseInt(ageEl.value,10);
      const r = +rateEl.value, i = +inflEl.value;
      const lam = +lamEl.value, m = +modalEl.value, b = +dispEl.value;

      const res = await webr.evalR(`ucase14n(x=${x}, lambda=${lam}, m=${m}, b=${b}, r=${r}, inflation=${i})`);
      let js = await res.toJs(); if(js&&js.type) js=unwrap(js);
      const R = js.results || {};

      const fair = num(R.fair_conversion_rate);
      const ann  = num(R.annuity_factor);

      document.getElementById("convOut").textContent = isFinite(fair)? fmtPct(fair) : "—";
      document.getElementById("annOut").textContent  = isFinite(ann) ? fmt(ann,{maximumFractionDigits:3}) : "—";

      const ages = arr(R.ages), surv = arr(R.survival);
      if(ages.length && surv.length) draw(ages, surv);

      log(js);
    }catch(e){ log("Compute error: "+(e?.message||e)); }
  }

  document.getElementById("compute").addEventListener("click", compute);
  [ageEl,rateEl,inflEl,lamEl,modalEl,dispEl].forEach(el=>el.addEventListener("input", compute));

  await init(); await compute();
</script>
</body>
</html>
