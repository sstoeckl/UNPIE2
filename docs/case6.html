<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UNPIE2 – Case 6</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module" src="https://webr.r-wasm.org/latest/webr.mjs"></script>
<style>
  html,body{height:100%;margin:0}
  body{overflow:hidden;font-family:system-ui,Segoe UI,Arial,sans-serif;background:#fff;color:#111}
  .app{height:640px;display:grid;place-items:stretch}
  .wrap{max-width:1100px;margin:0 auto;padding:8px 12px;height:100%;box-sizing:border-box}
  .title{text-align:center;margin:4px 0 8px;font-size:1.15rem}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:12px;height:calc(100% - 38px)}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .panel{border:1px solid #e8e8e8;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff}
  .left{padding:10px;overflow:auto}
  .group{border:1px solid #ddd;border-radius:10px;padding:10px;margin-bottom:10px}
  .group h3{margin:0 0 8px;font-size:1rem}
  .row{display:flex;align-items:center;gap:.8rem}
  .row + .row{margin-top:8px}
  .val{width:7rem;text-align:right;color:#666;font-variant-numeric:tabular-nums}
  input[type=range]{width:100%}
  button{padding:.55rem .9rem;border:0;border-radius:10px;background:#eee;cursor:pointer}
  .right{padding:10px;display:flex;flex-direction:column;height:100%;overflow:hidden}
  .chartWrap{flex:1 0 auto;height:360px}
  #bar{width:100%;height:100%}
  .legend{display:flex;gap:1rem;justify-content:center;margin-top:6px;color:#666;font-size:.92rem;flex:0 0 auto;flex-wrap:wrap}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:.35rem;vertical-align:middle}
  .kpis{display:flex;gap:12px;justify-content:center;margin-top:6px;flex:0 0 auto;flex-wrap:wrap}
  .kpi{background:#f7f7f9;border-radius:10px;padding:.45rem .7rem;font-variant-numeric:tabular-nums}
  .debug{margin-top:6px;background:#f7f7f9;border-radius:10px;padding:6px;overflow:auto;flex:0 0 110px;display:none}
  pre{margin:0;font-size:.82rem}
</style>
</head>
<body>
<div class="app">
  <div class="wrap">
    <div class="title" id="title">App 6: Required starting capital for constant periodic expenses</div>
    <div class="grid">
      <div class="panel left">
        <div class="group">
          <h3 id="gPmt">Periodic expenses</h3>
          <div class="row">
            <label for="pmt" style="flex:1" id="lPmt">Expense per year</label>
            <input id="pmt" type="range" min="10" max="10000" step="10" value="100">
            <div class="val" id="pmtLabel">100</div>
          </div>
        </div>
        <div class="group">
          <h3 id="gHor">Time horizon (years)</h3>
          <div class="row">
            <label for="nper" style="flex:1" id="lYears">Years</label>
            <input id="nper" type="range" min="1" max="50" step="1" value="5">
            <div class="val" id="nperLabel">5</div>
          </div>
        </div>
        <div class="group">
          <h3 id="gRate">Interest rate</h3>
          <div class="row">
            <label for="rate" style="flex:1" id="lRate">Rate (per year)</label>
            <input id="rate" type="range" min="0" max="0.08" step="0.0005" value="0.03">
            <div class="val" id="rateLabel">3.00%</div>
          </div>
        </div>
        <button id="compute">Compute</button>
      </div>

      <div class="panel right">
        <div class="chartWrap"><canvas id="bar"></canvas></div>
        <div class="legend">
          <span><span class="dot" style="background:#9e9e9e"></span><span id="legSum">Sum of periodic expenses</span></span>
          <span><span class="dot" style="background:#2e7d32"></span><span id="legPV">Required starting capital</span></span>
          <span><span class="dot" style="background:#ff9800"></span><span id="legPmt">Periodic expense</span></span>
        </div>
        <div class="kpis">
          <div class="kpi"><strong id="kpiSumLbl">Sum of periodic expenses:</strong> <span id="sumOut">—</span></div>
          <div class="kpi"><strong id="kpiPvLbl">Required starting capital:</strong> <span id="pvOut">—</span></div>
        </div>
        <div class="debug" id="debugBox"><pre id="debug">Waiting…</pre></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // Params & i18n
  const params=new URLSearchParams(location.search);
  const lang =(params.get("lang") || "en_EN").toLowerCase();
  const debug=(params.get("debug")||"FALSE").toUpperCase()==="TRUE";

  const I18N={
    en_en:{title:"App 6: Required starting capital for constant periodic expenses",
      gPmt:"Periodic expenses", lPmt:"Expense per year",
      gHor:"Time horizon (years)", lYears:"Years",
      gRate:"Interest rate", lRate:"Rate (per year)", btn:"Compute",
      legSum:"Sum of periodic expenses", legPV:"Required starting capital", legPmt:"Periodic expense",
      kpiSumLbl:"Sum of periodic expenses:", kpiPvLbl:"Required starting capital:"},
    de_de:{title:"App 6: Notwendiges Ausgangsvermögen zur Finanzierung konstanter periodischer Ausgaben",
      gPmt:"Periodische Ausgaben", lPmt:"Ausgabe pro Jahr",
      gHor:"Zeitraum (Jahre)", lYears:"Jahre",
      gRate:"Zinssatz", lRate:"Zinssatz (pro Jahr)", btn:"Berechnen",
      legSum:"Summe der periodischen Ausgaben", legPV:"Notwendiges Ausgangsvermögen", legPmt:"Periodische Ausgabe",
      kpiSumLbl:"Summe der periodischen Ausgaben:", kpiPvLbl:"Notwendiges Ausgangsvermögen:"}
  };
  const T=I18N[lang]||I18N.en_en;
  ["title","gPmt","lPmt","gHor","lYears","gRate","lRate","legSum","legPV","legPmt","kpiSumLbl","kpiPvLbl"]
    .forEach(id=>document.getElementById(id).textContent=T[id]);
  document.getElementById("compute").textContent=T.btn;
  document.getElementById("debugBox").style.display=debug?"block":"none";

  // UI
  const pmtEl=document.getElementById("pmt"), nperEl=document.getElementById("nper"), rateEl=document.getElementById("rate");
  const pmtLbl=document.getElementById("pmtLabel"), nperLbl=document.getElementById("nperLabel"), rateLbl=document.getElementById("rateLabel");
  const sumOut=document.getElementById("sumOut"), pvOut=document.getElementById("pvOut"), dbg=document.getElementById("debug");
  const fmt=(x,opts={})=>Number(x).toLocaleString(undefined,{maximumFractionDigits:2,...opts});
  const log=x=>{ if(debug) dbg.textContent=typeof x==="string"?x:JSON.stringify(x,null,2); };
  function refresh(){ pmtLbl.textContent=fmt(pmtEl.value,{maximumFractionDigits:0});
    nperLbl.textContent=parseInt(nperEl.value,10);
    rateLbl.textContent=(parseFloat(rateEl.value)*100).toFixed(2)+"%"; } refresh();

  // Chart
  let xBase=0,xTotal=0;
  const ctx=document.getElementById("bar").getContext("2d");
  const bar=new Chart(ctx,{type:"bar",data:{labels:[],datasets:[]},
    options:{
      responsive:true,maintainAspectRatio:false,
      scales:{
        x:{ticks:{autoSkip:false,callback:function(v){ if(v<2) return "0"; if(v<xTotal-1) return this.getLabelForValue(v-1); return "T"; }},
           title:{display:true,text:"T"}},
        y:{beginAtZero:true,title:{display:true,text:"Value"},ticks:{callback:v=>fmt(v)}}
      },
      plugins:{legend:{display:false}},
      datasets:{bar:{grouped:false,barPercentage:1.0,categoryPercentage:1.0}}
    }});

  // Replace your existing drawChart in case6.html with this one
  function drawChart(t, expensePath, sumExp, pvReq) {
    // Two "0" slots at start for grey/green; then 1..n. No trailing "T" category.
    const labels = ["0", "0", ...t.map(String)];
    xBase  = t.length + 1;      // used by your tick formatter (keeps 'T' printed on last tick if you want)
    xTotal = labels.length;
  
    const orange = [null, null, ...expensePath];    // periodic expenses along the years
    const grey   = Array(xTotal).fill(null); grey[0] = sumExp;  // first "0"
    const green  = Array(xTotal).fill(null); green[1] = pvReq;  // second "0"
  
    bar.data.labels   = labels;
    bar.data.datasets = [
      { label: "Sum", data: grey,   backgroundColor: "#9e9e9e" },
      { label: "PV",  data: green,  backgroundColor: "#2e7d32" },
      { label: "Pmt", data: orange, backgroundColor: "#ff9800" }
    ];
    bar.update();
  }


  // WebR
  import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";
  const webr=new WebR();
  function unwrap(x){ if(x==null||typeof x!=="object")return x; if(x.type==="list"){const o={};(x.names||[]).forEach((k,i)=>o[k]=unwrap(x.values[i]));return o;}
    if(Array.isArray(x.values)) return x.values.length===1?unwrap(x.values[0]):x.values.map(unwrap); return x; }
  const num=x=>typeof x==="number"?x:(x&&x.values?x.values[0]:Array.isArray(x)?x[0]:NaN);
  const arr=x=>Array.isArray(x)?x.map(num):(x&&x.values?x.values.map(num):[]);

  async function init(){ log("Starting WebR…"); await webr.init(); const code=await (await fetch("./r/ucase6.R")).text(); await webr.evalR(code); log("WebR ready."); }
  async function compute(){
    try{
      refresh();
      const r=await webr.evalR(`ucase6(pmt=${+pmtEl.value}, nper=${parseInt(nperEl.value,10)}, rate=${+rateEl.value})`);
      let js=await r.toJs(); if(js&&js.type) js=unwrap(js);
      const res=js.results||{};
      const t=arr(res.t), expensePath=arr(res.expense_path);
      const sumExp=num(res.sum_expenses), pvReq=num(res.pv_required);

      sumOut.textContent=fmt(sumExp,{maximumFractionDigits:0});
      pvOut.textContent =fmt(pvReq);
      drawChart(t, expensePath, sumExp, pvReq);
      log(js);
    }catch(e){ log("Compute error: "+(e?.message||e)); }
  }

  document.getElementById("compute").addEventListener("click", compute);
  [pmtEl,nperEl,rateEl].forEach(el=>el.addEventListener("input", compute));
  await init(); await compute();
</script>
</body>
</html>
