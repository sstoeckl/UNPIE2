<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UNPIE2 – Case 7</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module" src="https://webr.r-wasm.org/latest/webr.mjs"></script>
<style>
  html,body{height:100%;margin:0}
  body{overflow:hidden;font-family:system-ui,Segoe UI,Arial,sans-serif;background:#fff;color:#111}
  .app{height:640px;display:grid;place-items:stretch}
  .wrap{max-width:1100px;margin:0 auto;padding:8px 12px;height:100%;box-sizing:border-box}
  .title{text-align:center;margin:4px 0 8px;font-size:1.15rem}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:12px;height:calc(100% - 38px)}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .panel{border:1px solid #e8e8e8;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff}
  .left{padding:10px;overflow:auto}
  .group{border:1px solid #ddd;border-radius:10px;padding:10px;margin-bottom:10px}
  .group h3{margin:0 0 8px;font-size:1rem}
  .row{display:flex;align-items:center;gap:.8rem}
  .row + .row{margin-top:8px}
  .val{width:7rem;text-align:right;color:#666;font-variant-numeric:tabular-nums}
  input[type=range]{width:100%}
  button{padding:.55rem .9rem;border:0;border-radius:10px;background:#eee;cursor:pointer}
  .right{padding:10px;display:flex;flex-direction:column;height:100%;overflow:hidden}
  .chartWrap{flex:1 0 auto;height:360px}
  #bar{width:100%;height:100%}
  .legend{display:flex;gap:1rem;justify-content:center;margin-top:6px;color:#666;font-size:.92rem;flex:0 0 auto;flex-wrap:wrap}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:.35rem;vertical-align:middle}
  .kpis{display:flex;gap:12px;justify-content:center;margin-top:6px;flex:0 0 auto;flex-wrap:wrap}
  .kpi{background:#f7f7f9;border-radius:10px;padding:.45rem .7rem;font-variant-numeric:tabular-nums}
  .debug{margin-top:6px;background:#f7f7f9;border-radius:10px;padding:6px;overflow:auto;flex:0 0 110px;display:none}
  pre{margin:0;font-size:.82rem}
</style>
</head>
<body>
<div class="app">
  <div class="wrap">
    <div class="title" id="title">App 7: Required wealth to finance constant (nominal/real) yearly spending</div>
    <div class="grid">
      <div class="panel left">
        <div class="group">
          <h3 id="gPmt">Yearly spending (base, real)</h3>
          <div class="row">
            <label for="pmt" style="flex:1" id="lPmt">Spending per year</label>
            <input id="pmt" type="range" min="10" max="20000" step="10" value="1000">
            <div class="val" id="pmtLabel">1,000</div>
          </div>
        </div>
        <div class="group">
          <h3 id="gHor">Time horizon (years)</h3>
          <div class="row">
            <label for="nper" style="flex:1" id="lYears">Years</label>
            <input id="nper" type="range" min="1" max="50" step="1" value="10">
            <div class="val" id="nperLabel">10</div>
          </div>
        </div>
        <div class="group">
          <h3 id="gRates">Rates</h3>
          <div class="row">
            <label for="rate" style="flex:1" id="lRate">Interest rate</label>
            <input id="rate" type="range" min="0" max="0.08" step="0.0005" value="0.02">
            <div class="val" id="rateLabel">2.00%</div>
          </div>
          <div class="row">
            <label for="infl" style="flex:1" id="lInfl">Inflation rate</label>
            <input id="infl" type="range" min="0" max="0.06" step="0.0005" value="0.01">
            <div class="val" id="inflLabel">1.00%</div>
          </div>
        </div>
        <button id="compute">Compute</button>
      </div>

      <div class="panel right">
        <div class="chartWrap"><canvas id="bar"></canvas></div>
        <div class="legend">
          <span><span class="dot" style="background:#ff9800"></span><span id="legNomFlat">Yearly spending (constant nominal)</span></span>
          <span><span class="dot" style="background:#9e9e9e"></span><span id="legNomIndexed">Yearly spending (indexed for inflation)</span></span>
          <span><span class="dot" style="background:#9e9e9e"></span><span id="legSumNom">Sum of yearly spending (nominal)</span></span>
          <span><span class="dot" style="background:#2e7d32"></span><span id="legPvNom">Required wealth (nominal spending)</span></span>
          <span><span class="dot" style="background:#1976d2"></span><span id="legPvReal">Required wealth (real spending)</span></span>
        </div>
        <div class="kpis">
          <div class="kpi"><strong id="kpiSumLbl">Sum of yearly spending (nominal):</strong> <span id="sumOut">—</span></div>
          <div class="kpi"><strong id="kpiPvNomLbl">Required wealth (nominal spending):</strong> <span id="pvNomOut">—</span></div>
          <div class="kpi"><strong id="kpiPvRealLbl">Required wealth (real spending):</strong> <span id="pvRealOut">—</span></div>
        </div>
        <div class="debug" id="debugBox"><pre id="debug">Waiting…</pre></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // Params & i18n
  const params=new URLSearchParams(location.search);
  const lang =(params.get("lang") || "en_EN").toLowerCase();
  const debug=(params.get("debug")||"FALSE").toUpperCase()==="TRUE";

  const I18N={
    en_en:{title:"App 7: Required wealth to finance constant (nominal/real) yearly spending",
      gPmt:"Yearly spending (base, real)", lPmt:"Spending per year",
      gHor:"Time horizon (years)", lYears:"Years",
      gRates:"Rates", lRate:"Interest rate", lInfl:"Inflation rate", btn:"Compute",
      legNomFlat:"Yearly spending (constant nominal)", legNomIndexed:"Yearly spending (indexed for inflation)",
      legSumNom:"Sum of yearly spending (nominal)", legPvNom:"Required wealth (nominal spending)", legPvReal:"Required wealth (real spending)",
      kpiSumLbl:"Sum of yearly spending (nominal):", kpiPvNomLbl:"Required wealth (nominal spending):", kpiPvRealLbl:"Required wealth (real spending):"},
    de_de:{title:"App 7: Notwendiges Vermögen zur Finanzierung konstanter (nominal/real) jährlicher Ausgaben",
      gPmt:"Jährliche Ausgaben (Basis, real)", lPmt:"Ausgaben pro Jahr",
      gHor:"Zeitraum (Jahre)", lYears:"Jahre",
      gRates:"Sätze", lRate:"Zinssatz", lInfl:"Inflationsrate", btn:"Berechnen",
      legNomFlat:"Jährliche Ausgaben (konstant nominal)", legNomIndexed:"Jährliche Ausgaben (inflationsindexiert)",
      legSumNom:"Summe der jährlichen Ausgaben (nominal)", legPvNom:"Notwendiges Vermögen (nominale Ausgaben)", legPvReal:"Notwendiges Vermögen (reale Ausgaben)",
      kpiSumLbl:"Summe der jährlichen Ausgaben (nominal):", kpiPvNomLbl:"Notwendiges Vermögen (nominale Ausgaben):", kpiPvRealLbl:"Notwendiges Vermögen (reale Ausgaben):"}
  };
  const T=I18N[lang]||I18N.en_en;
  ["title","gPmt","lPmt","gHor","lYears","gRates","lRate","lInfl",
   "legNomFlat","legNomIndexed","legSumNom","legPvNom","legPvReal",
   "kpiSumLbl","kpiPvNomLbl","kpiPvRealLbl"].forEach(id=>document.getElementById(id).textContent=T[id]);
  document.getElementById("compute").textContent=T.btn;
  document.getElementById("debugBox").style.display=debug?"block":"none";

  // UI
  const pmtEl=document.getElementById("pmt"), nperEl=document.getElementById("nper");
  const rateEl=document.getElementById("rate"), inflEl=document.getElementById("infl");
  const pmtLbl=document.getElementById("pmtLabel"), nperLbl=document.getElementById("nperLabel");
  const rateLbl=document.getElementById("rateLabel"), inflLbl=document.getElementById("inflLabel");
  const sumOut=document.getElementById("sumOut"), pvNomOut=document.getElementById("pvNomOut"), pvRealOut=document.getElementById("pvRealOut");
  const dbg=document.getElementById("debug");
  const fmt=(x,opts={})=>Number(x).toLocaleString(undefined,{maximumFractionDigits:2,...opts});
  const log=x=>{ if(debug) dbg.textContent=typeof x==="string"?x:JSON.stringify(x,null,2); };
  function refresh(){ pmtLbl.textContent=fmt(pmtEl.value,{maximumFractionDigits:0});
    nperLbl.textContent=parseInt(nperEl.value,10);
    rateLbl.textContent=(parseFloat(rateEl.value)*100).toFixed(2)+"%";
    inflLbl.textContent=(parseFloat(inflEl.value)*100).toFixed(2)+"%"; } refresh();

  // Chart
  let xBase=0,xTotal=0;
  const ctx=document.getElementById("bar").getContext("2d");
  const bar=new Chart(ctx,{type:"bar",data:{labels:[],datasets:[]},
    options:{
      responsive:true,maintainAspectRatio:false,
      scales:{
        x:{
          ticks:{
            autoSkip:false,
            callback:function(v){
              // show "0" for first two slots, then only the first slot label of each year-pair, and "T" on the last slot
              if (v < 2) return "0";
              if (v === xTotal - 1) return "T";
              // inside yearly pairs starting at index 2: show label only on the first of the pair
              const idxInPairs = v - 2;
              return (idxInPairs % 2 === 0) ? this.getLabelForValue(v) : "";
            }
          },
          title:{display:true,text:"T"}
        },
        y:{beginAtZero:true,title:{display:true,text:"Value"},ticks:{callback:v=>fmt(v)}}
      },
      plugins:{legend:{display:false}},
      datasets:{bar:{grouped:false,barPercentage:0.95,categoryPercentage:1.0}}
    }});

  function drawChart(t, pathNomFlat, pathNomIndexed, sumNom, pvNom, pvReal) {
    // pair labels for years: 1,1,2,2,...
    const pairLabels=[]; const orange=[]; const grey=[];
    t.forEach((ti, idx) => {
      pairLabels.push(String(ti), String(ti));
      orange.push(pathNomFlat[idx], null);      // orange on first slot
      grey.push(null, pathNomIndexed[idx]);     // grey on second slot
    });

    // labels: two left "0" slots (green + blue), then pairs, then trailing "T" for the sum
    const labels=["0","0", ...pairLabels, "T"];
    xBase  = labels.length - 1; // last index holds "T"
    xTotal = labels.length;

    const green = Array(xTotal).fill(null); green[0] = pvNom;  // left-most
    const blue  = Array(xTotal).fill(null); blue[1] = pvReal;  // second-left
    const orangeData = [null, null, ...orange];
    const greyData   = [null, null, ...grey];
    const sumArr = Array(xTotal).fill(null); sumArr[xTotal-1] = sumNom; // right-most "T"

    bar.data.labels=labels;
    bar.data.datasets=[
      { label:"NomFlat", data:orangeData, backgroundColor:"#ff9800" },
      { label:"NomIndexed", data:greyData, backgroundColor:"#9e9e9e" },
      { label:"SumNom", data:sumArr, backgroundColor:"#9e9e9e" },
      { label:"PvNom", data:green, backgroundColor:"#2e7d32" },
      { label:"PvReal", data:blue, backgroundColor:"#1976d2" }
    ];
    bar.update();
  }

  // WebR
  import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";
  const webr=new WebR();
  function unwrap(x){ if(x==null||typeof x!=="object")return x; if(x.type==="list"){const o={};(x.names||[]).forEach((k,i)=>o[k]=unwrap(x.values[i]));return o;}
    if(Array.isArray(x.values)) return x.values.length===1?unwrap(x.values[0]):x.values.map(unwrap); return x; }
  const num=x=>typeof x==="number"?x:(x&&x.values?x.values[0]:Array.isArray(x)?x[0]:NaN);
  const arr=x=>Array.isArray(x)?x.map(num):(x&&x.values?x.values.map(num):[]);

  async function init(){
    log("Starting WebR…");
    await webr.init();
    const code = await (await fetch("./r/ucase7.R")).text();
    await webr.evalR(code);
    log("WebR ready.");
  }

  async function compute(){
    try{
      refresh();
      const p=+pmtEl.value, n=parseInt(nperEl.value,10), r=+rateEl.value, i=+inflEl.value;
      const res=await webr.evalR(`ucase7(pmt=${p}, nper=${n}, rate=${r}, inflation=${i})`);
      let js=await res.toJs(); if(js&&js.type) js=unwrap(js);
      const R=js.results||{};
      const t=arr(R.t),
            nomFlat=arr(R.expense_nominal_path),
            nomIdx =arr(R.expense_real_nominal_path),
            sumNom =num(R.sum_nominal),
            pvNom  =num(R.pv_required_nominal),
            pvReal =num(R.pv_required_real);

      sumOut.textContent   = fmt(sumNom,{maximumFractionDigits:0});
      pvNomOut.textContent = fmt(pvNom);
      pvRealOut.textContent= fmt(pvReal);
      drawChart(t, nomFlat, nomIdx, sumNom, pvNom, pvReal);
      log(js);
    }catch(e){ log("Compute error: "+(e?.message||e)); }
  }

  document.getElementById("compute").addEventListener("click", compute);
  [pmtEl,nperEl,rateEl,inflEl].forEach(el=>el.addEventListener("input", compute));
  await init(); await compute();
</script>
</body>
</html>
