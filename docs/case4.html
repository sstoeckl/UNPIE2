<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UNPIE2 – Case 4</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module" src="https://webr.r-wasm.org/latest/webr.mjs"></script>

<style>
  html,body{height:100%;margin:0}
  body{overflow:hidden;font-family:system-ui,Segoe UI,Arial,sans-serif;background:#fff;color:#111}
  .app{height:640px;display:grid;place-items:stretch}
  .wrap{max-width:1100px;margin:0 auto;padding:8px 12px;height:100%;box-sizing:border-box}
  .title{text-align:center;margin:4px 0 8px;font-size:1.15rem}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:12px;height:calc(100% - 38px)}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .panel{border:1px solid #e8e8e8;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff}
  .left{padding:10px;overflow:auto}
  .group{border:1px solid #ddd;border-radius:10px;padding:10px;margin-bottom:10px}
  .group h3{margin:0 0 8px;font-size:1rem}
  .row{display:flex;align-items:center;gap:.8rem}
  .row + .row{margin-top:8px}
  .val{width:7rem;text-align:right;color:#666;font-variant-numeric:tabular-nums}
  input[type=range]{width:100%}
  button{padding:.55rem .9rem;border:0;border-radius:10px;background:#eee;cursor:pointer}

  .right{padding:10px;display:flex;flex-direction:column;height:100%;overflow:hidden}
  .chartWrap{flex:1 0 auto;height:360px}
  #bar{width:100%;height:100%}
  .legend{display:flex;gap:1rem;justify-content:center;margin-top:6px;color:#666;font-size:.92rem;flex:0 0 auto;flex-wrap:wrap}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:.35rem;vertical-align:middle}
  .kpis{display:flex;gap:12px;justify-content:center;margin-top:6px;flex:0 0 auto;flex-wrap:wrap}
  .kpi{background:#f7f7f9;border-radius:10px;padding:.45rem .7rem;font-variant-numeric:tabular-nums}
  .debug{margin-top:6px;background:#f7f7f9;border-radius:10px;padding:6px;overflow:auto;flex:0 0 110px;display:none}
  pre{margin:0;font-size:.82rem}
</style>
</head>
<body>
  <div class="app">
    <div class="wrap">
      <div class="title" id="title">App 4: Future value (nominal & real) of nominally constant periodic payments</div>

      <div class="grid">
        <!-- Controls -->
        <div class="panel left">
          <div class="group">
            <h3 id="gPmt">Periodic payments</h3>
            <div class="row">
              <label for="pmt" style="flex:1" id="lPmt">Payment per year</label>
              <input id="pmt" type="range" min="1000" max="100000" step="100" value="34600">
              <div class="val" id="pmtLabel">34,600</div>
            </div>
          </div>

          <div class="group">
            <h3 id="gHor">Time horizon (years)</h3>
            <div class="row">
              <label for="nper" style="flex:1" id="lYears">Years</label>
              <input id="nper" type="range" min="1" max="50" step="1" value="35">
              <div class="val" id="nperLabel">35</div>
            </div>
          </div>

          <div class="group">
            <h3 id="gRates">Rates</h3>
            <div class="row">
              <label for="rate" style="flex:1" id="lRate">Interest rate</label>
              <input id="rate" type="range" min="0" max="0.08" step="0.0005" value="0.02">
              <div class="val" id="rateLabel">2.00%</div>
            </div>
            <div class="row">
              <label for="infl" style="flex:1" id="lInfl">Inflation rate</label>
              <input id="infl" type="range" min="0" max="0.06" step="0.0005" value="0.01">
              <div class="val" id="inflLabel">1.00%</div>
            </div>
          </div>

          <button id="compute">Compute</button>
        </div>

        <!-- Chart & KPIs -->
        <div class="panel right">
          <div class="chartWrap"><canvas id="bar"></canvas></div>
          <div class="legend">
            <span><span class="dot" style="background:#ff9800"></span><span id="legPmt">Periodic payment</span></span>
            <span><span class="dot" style="background:#9e9e9e"></span><span id="legSum">Sum of periodic payments (nominal)</span></span>
            <span><span class="dot" style="background:#2e7d32"></span><span id="legFVNom">Future value (nominal)</span></span>
            <span><span class="dot" style="background:#1976d2"></span><span id="legFVReal">Future value (real)</span></span>
          </div>
          <div class="kpis">
            <div class="kpi"><strong id="kpiSumLbl">Sum of periodic payments (nominal):</strong> <span id="sumOut">—</span></div>
            <div class="kpi"><strong id="kpiFvNomLbl">Future value (nominal):</strong> <span id="fvNomOut">—</span></div>
            <div class="kpi"><strong id="kpiFvRealLbl">Future value (real):</strong> <span id="fvRealOut">—</span></div>
          </div>
          <div class="debug" id="debugBox"><pre id="debug">Waiting…</pre></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ---- URL params
    const params = new URLSearchParams(location.search);
    const lang = (params.get("lang") || "en_EN").toLowerCase();
    const debug = (params.get("debug") || "FALSE").toUpperCase() === "TRUE";

    // ---- i18n
    const I18N = {
      en_en: {
        title: "App 4: Future value (nominal & real) of nominally constant periodic payments",
        gPmt: "Periodic payments", lPmt: "Payment per year",
        gHor: "Time horizon (years)", lYears: "Years",
        gRates: "Rates", lRate: "Interest rate", lInfl: "Inflation rate",
        btn: "Compute",
        legPmt: "Periodic payment",
        legSum: "Sum of periodic payments (nominal)",
        legFVNom: "Future value (nominal)",
        legFVReal: "Future value (real)",
        kpiSumLbl: "Sum of periodic payments (nominal):",
        kpiFvNomLbl: "Future value (nominal):",
        kpiFvRealLbl: "Future value (real):"
      },
      de_de: {
        title: "App 4: Zukünftiger Wert (nominal und real) von nominell konstanten periodischen Sparzahlungen",
        gPmt: "Periodische Sparzahlungen", lPmt: "Sparzahlung pro Jahr",
        gHor: "Zeitraum (Jahre)", lYears: "Jahre",
        gRates: "Sätze", lRate: "Zinssatz", lInfl: "Inflationsrate",
        btn: "Berechnen",
        legPmt: "Periodische Sparzahlung",
        legSum: "Summe der periodischen Sparzahlungen (nominal)",
        legFVNom: "Zukünftiger Wert (nominal)",
        legFVReal: "Zukünftiger Wert (real)",
        kpiSumLbl: "Summe der periodischen Sparzahlungen (nominal):",
        kpiFvNomLbl: "Zukünftiger Wert (nominal):",
        kpiFvRealLbl: "Zukünftiger Wert (real):"
      }
    };
    const T = I18N[lang] || I18N.en_en;
    [
      "title","gPmt","lPmt","gHor","lYears","gRates","lRate","lInfl",
      "legPmt","legSum","legFVNom","legFVReal","kpiSumLbl","kpiFvNomLbl","kpiFvRealLbl"
    ].forEach(id => document.getElementById(id).textContent = T[id]);
    document.getElementById("compute").textContent = T.btn;
    document.getElementById("debugBox").style.display = debug ? "block" : "none";

    // ---- UI refs
    const pmtEl = document.getElementById("pmt");
    const nperEl= document.getElementById("nper");
    const rateEl= document.getElementById("rate");
    const inflEl= document.getElementById("infl");
    const pmtLbl= document.getElementById("pmtLabel");
    const nperLbl=document.getElementById("nperLabel");
    const rateLbl=document.getElementById("rateLabel");
    const inflLbl=document.getElementById("inflLabel");

    const sumOut   = document.getElementById("sumOut");
    const fvNomOut = document.getElementById("fvNomOut");
    const fvRealOut= document.getElementById("fvRealOut");
    const dbg = document.getElementById("debug");

    const fmt=(x,opts={})=>Number(x).toLocaleString(undefined,{maximumFractionDigits:2,...opts});
    const log=x=>{ if(debug) dbg.textContent = typeof x==="string"?x:JSON.stringify(x,null,2); };
    function refreshLabels(){
      pmtLbl.textContent  = fmt(pmtEl.value,{maximumFractionDigits:0});
      nperLbl.textContent = parseInt(nperEl.value,10);
      rateLbl.textContent = (parseFloat(rateEl.value)*100).toFixed(2) + "%";
      inflLbl.textContent = (parseFloat(inflEl.value)*100).toFixed(2) + "%";
    }
    refreshLabels();

    // ---- Chart: orange bars per year; at T show gray, green, blue
    const ctx = document.getElementById("bar").getContext("2d");
    const bar = new Chart(ctx, {
      type: "bar",
      data: { labels: [], datasets: [] },
      options: {
        responsive:true, maintainAspectRatio:false,
        scales:{
          x:{ title:{display:true,text:"T"}, stacked:false, ticks:{autoSkip:false} },
          y:{ beginAtZero:true, title:{display:true,text:"Value"}, ticks:{ callback:v=>fmt(v) }}
        },
        plugins:{ legend:{ display:false } },
        datasets: { bar: { barPercentage: 1.0, categoryPercentage: 1.0 } }
      }
    });
    
    function drawChart(labels, contrib, sumNom, fvNom, fvReal) {
      const n = labels.length;
    
      bar.data.labels = labels;
      bar.data.datasets = [
        // periodic payments across all years
        { label: "Periodic", data: contrib, backgroundColor: "#ff9800" },
    
        // three bars at the last period; overlap them
        { label: "SumNom", data: Array(n).fill(null).map((_, i) => i === n - 1 ? sumNom : null),
          backgroundColor: "#9e9e9e" },
    
        { label: "FVNom",  data: Array(n).fill(null).map((_, i) => i === n - 1 ? fvNom : null),
          backgroundColor: "#2e7d32" },
    
        { label: "FVReal", data: Array(n).fill(null).map((_, i) => i === n - 1 ? fvReal : null),
          backgroundColor: "#1976d2" }
      ];
    
      bar.update();
    }

    // ---- WebR
    import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";
    const webr = new WebR();
    function unwrap(x){ if(x==null||typeof x!=="object")return x; if(x.type==="list"){const o={};(x.names||[]).forEach((k,i)=>o[k]=unwrap(x.values[i]));return o;} if(Array.isArray(x.values)) return x.values.length===1?unwrap(x.values[0]):x.values.map(unwrap); return x; }
    
    // Extract a single number from any WebR/JS shape
    function num(x) {
      if (typeof x === "number") return x;
      if (x && typeof x === "object") {
        if (Array.isArray(x)) return num(x[0]);
        if ("values" in x)    return num(x.values[0]);
      }
      return NaN;
    }
    
    // Extract an array of numbers from any WebR/JS vector shape
    function arr(x) {
      if (Array.isArray(x))   return x.map(num);
      if (x && x.values)      return x.values.map(num);
      return [];
    }

    async function init(){
      log("Starting WebR…");
      await webr.init();
      const code = await (await fetch("./r/ucase4.R")).text();
      await webr.evalR(code);
      log("WebR ready. ucase4() loaded.");
    }

    async function compute(){
      try{
        refreshLabels();
        const pmt = parseFloat(pmtEl.value);
        const nper= parseInt(nperEl.value,10);
        const rate= parseFloat(rateEl.value);
        const infl= parseFloat(inflEl.value);
    
        const r   = await webr.evalR(`ucase4(pmt=${pmt}, nper=${nper}, rate=${rate}, inflation=${infl})`);
        let js = await r.toJs();
        if (js && js.type) js = unwrap(js);
    
        const res = js?.results || {};
        const sumNom = num(res.sum_nominal);
        const fvNom  = num(res.fv_nominal);
        const fvReal = num(res.fv_real);
        const t      = arr(res.t);
        const contrib= arr(res.contrib_path);
    
        if (![sumNom,fvNom,fvReal].every(Number.isFinite) || !contrib.length || !t.length) {
          throw new Error("Shape mismatch");
        }
    
        sumOut.textContent    = fmt(sumNom, { maximumFractionDigits: 0 });
        fvNomOut.textContent  = fmt(fvNom);
        fvRealOut.textContent = fmt(fvReal);
    
        const labels = t.map(String);
        drawChart(labels, contrib, sumNom, fvNom, fvReal);
        log(js);
      } catch (e){
        log("Compute error: " + (e?.message || e));
      }
    }
        // ---- Event listeners

    document.getElementById("compute").addEventListener("click", compute);
    [pmtEl,nperEl,rateEl,inflEl].forEach(el=>el.addEventListener("input", compute));

    await init();
    await compute();
  </script>
</body>
</html>
