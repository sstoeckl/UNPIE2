<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UNPIE2 – Case 8</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module" src="https://webr.r-wasm.org/latest/webr.mjs"></script>

<style>
  html,body{height:100%;margin:0}
  body{overflow:hidden;font-family:system-ui,Segoe UI,Arial,sans-serif;background:#fff;color:#111}
  .wrap{max-width:1100px;margin:0 auto;padding:8px 12px;height:100%;box-sizing:border-box}
  .title{text-align:center;margin:4px 0 8px;font-size:1.15rem}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:12px;height:calc(100% - 38px)}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .panel{border:1px solid #e8e8e8;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff}
  .left{padding:10px;overflow:auto}
  .group{border:1px solid #ddd;border-radius:10px;padding:10px;margin-bottom:10px}
  .group h3{margin:0 0 8px;font-size:1rem}
  .row{display:flex;align-items:center;gap:.8rem}
  .row + .row{margin-top:8px}
  .val{width:7rem;text-align:right;color:#666;font-variant-numeric:tabular-nums}
  input[type=range]{width:100%}
  button{padding:.55rem .9rem;border:0;border-radius:10px;background:#eee;cursor:pointer}
  .right{padding:10px;display:flex;flex-direction:column;height:100%;overflow:hidden}
  .chartWrap{flex:1 0 auto;height:320px}
  #bar{width:100%;height:100%}
  .legend{display:flex;gap:1rem;justify-content:center;margin-top:6px;color:#666;font-size:.92rem;flex:0 0 auto}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:.35rem;vertical-align:middle}
  .below{margin-top:10px}
  .belowLine{margin:6px 0;}
  .highlight{background:#f7f7f9;border-radius:6px;padding:.15rem .35rem;font-variant-numeric:tabular-nums}
  .debug{margin-top:6px;background:#f7f7f9;border-radius:10px;padding:6px;overflow:auto;flex:0 0 110px;display:none}
  pre{margin:0;font-size:.82rem}

  /* Außenrahmen + Copyright, wie bei den anderen Apps */
  .app-shell{max-width:1120px;width:min(1120px,calc(100% - 16px));margin:10px auto;
    border:1px solid #d9d9df;border-radius:10px;background:#fff;padding:6px;
    display:grid;grid-template-rows:auto min-content;row-gap:18px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .app-shell__footer{justify-self:end;align-self:end;font-size:.75rem;color:#666;white-space:nowrap}
</style>
</head>
<body>
<div class="app-shell">
  <div class="wrap">
    <div class="title" id="title">App 8: Real yearly spending financed by given (real) yearly savings</div>

    <div class="grid">
      <!-- Controls -->
      <div class="panel left">
        <div class="group">
          <h3 id="gPmt">Yearly (real) savings payments</h3>
          <div class="row">
            <label for="pmt" style="flex:1" id="lPmt">Payment per year</label>
            <input id="pmt" type="range" min="100" max="100000" step="50" value="1000">
            <div class="val" id="pmtLabel">1,000</div>
          </div>
        </div>

        <div class="group">
          <h3 id="gHorSave">Time horizon for savings (years)</h3>
          <div class="row">
            <label for="nSave" style="flex:1" id="lSave">Years</label>
            <input id="nSave" type="range" min="1" max="50" step="1" value="25">
            <div class="val" id="nSaveLabel">25</div>
          </div>
        </div>

        <div class="group">
          <h3 id="gHorSpend">Time horizon for spending (years)</h3>
          <div class="row">
            <label for="nSpend" style="flex:1" id="lSpend">Years</label>
            <input id="nSpend" type="range" min="1" max="50" step="1" value="20">
            <div class="val" id="nSpendLabel">20</div>
          </div>
        </div>

        <div class="group">
          <h3 id="gRates">Rates</h3>
          <div class="row">
            <label for="rate" style="flex:1" id="lRate">Interest rate</label>
            <input id="rate" type="range" min="0" max="0.08" step="0.0005" value="0.03">
            <div class="val" id="rateLabel">3.00%</div>
          </div>
          <div class="row">
            <label for="infl" style="flex:1" id="lInfl">Inflation rate</label>
            <input id="infl" type="range" min="0" max="0.06" step="0.0005" value="0.01">
            <div class="val" id="inflLabel">1.00%</div>
          </div>
        </div>

        <button id="compute">Compute</button>
      </div>

      <!-- Chart & below text -->
      <div class="panel right">
        <div class="chartWrap"><canvas id="bar"></canvas></div>
        <div class="legend">
          <span><span class="dot" style="background:#ff9800"></span><span id="legSave">Yearly (real) savings while working</span></span>
          <span><span class="dot" style="background:#9e9e9e"></span><span id="legSpend">Yearly (real) spending during retirement</span></span>
        </div>

        <div class="below">
          <div class="belowLine">
            <strong id="lblFV">Future wealth at end of savings phase (real) available to finance (real) yearly spending during retirement:</strong>
            <span id="fvOut" class="highlight">—</span>
          </div>
          <div class="belowLine">
            <strong id="lblSpend">Yearly spending possible (real):</strong>
            <span id="spendOut" class="highlight">—</span>
          </div>
        </div>

        <div class="debug" id="debugBox"><pre id="debug">Waiting…</pre></div>
      </div>
    </div>
  </div>
  <div class="app-shell__footer">© 2025 by Dr. S. Stöckl</div>
</div>

<script type="module">
  // URL params
  const params=new URLSearchParams(location.search);
  const lang=(params.get("lang")||"en_EN").toLowerCase();
  const debug=(params.get("debug")||"FALSE").toUpperCase()==="TRUE";

  // i18n
  const I18N={
    en_en:{
      title:"App 8: Real yearly spending financed by given (real) yearly savings",
      gPmt:"Yearly (real) savings payments", lPmt:"Payment per year",
      gHorSave:"Time horizon for savings (years)", lSave:"Years",
      gHorSpend:"Time horizon for spending (years)", lSpend:"Years",
      gRates:"Rates", lRate:"Interest rate", lInfl:"Inflation rate", btn:"Compute",
      legSave:"Yearly (real) savings while working", legSpend:"Yearly (real) spending during retirement",
      lblFV:"Future wealth at end of savings phase (real) available to finance (real) yearly spending during retirement:",
      lblSpend:"Yearly spending possible (real):"
    },
    de_de:{
      title:"App 8: Reale jährliche Ausgaben finanziert durch gegebene (reale) jährliche Ersparnisse",
      gPmt:"Jährliche (reale) Sparzahlungen", lPmt:"Zahlung pro Jahr",
      gHorSave:"Sparhorizont (Jahre)", lSave:"Jahre",
      gHorSpend:"Auszahlungshorizont (Jahre)", lSpend:"Jahre",
      gRates:"Sätze", lRate:"Zinssatz", lInfl:"Inflationsrate", btn:"Berechnen",
      legSave:"Jährliche (reale) Ersparnisse während Erwerbsphase",
      legSpend:"Jährliche (reale) Ausgaben im Ruhestand",
      lblFV:"Zukünftiges Vermögen am Ende der Sparphase (real) zur Finanzierung der (realen) jährlichen Ausgaben im Ruhestand:",
      lblSpend:"Mögliche jährliche Ausgaben (real):"
    }
  };
  const T=I18N[lang]||I18N.en_en;
  ["title","gPmt","lPmt","gHorSave","lSave","gHorSpend","lSpend","gRates","lRate","lInfl",
   "legSave","legSpend","lblFV","lblSpend"].forEach(id=>document.getElementById(id).textContent=T[id]);
  document.getElementById("compute").textContent=T.btn;
  document.getElementById("debugBox").style.display=debug?"block":"none";

  // UI
  const pmtEl=pmt, nSaveEl=nSave, nSpendEl=nSpend, rateEl=rate, inflEl=infl;
  const pmtLabelEl=pmtLabel, nSaveLabelEl=nSaveLabel, nSpendLabelEl=nSpendLabel, rateLabelEl=rateLabel, inflLabelEl=inflLabel;
  const fvOut=document.getElementById("fvOut");
  const spendOut=document.getElementById("spendOut");
  const dbg=document.getElementById("debug");

  const fmt=(x,opts={})=>Number(x).toLocaleString(undefined,{maximumFractionDigits:2,...opts});
  const pct=x=>(parseFloat(x)*100).toFixed(2)+"%";
  const log=x=>{ if(debug) dbg.textContent=typeof x==="string"?x:JSON.stringify(x,null,2); };

  function refresh(){
    pmtLabelEl.textContent=fmt(pmtEl.value,{maximumFractionDigits:0});
    nSaveLabelEl.textContent=parseInt(nSaveEl.value,10);
    nSpendLabelEl.textContent=parseInt(nSpendEl.value,10);
    rateLabelEl.textContent=pct(rateEl.value);
    inflLabelEl.textContent=pct(inflEl.value);
  } refresh();

  // Chart
  const ctx=document.getElementById("bar").getContext("2d");
  const bar=new Chart(ctx,{type:"bar",
    data:{labels:["Save","Spend"],datasets:[]},
    options:{
      responsive:true,maintainAspectRatio:false,
      scales:{x:{ticks:{autoSkip:false}},y:{beginAtZero:true,title:{display:true,text:"Value"},ticks:{callback:v=>fmt(v)}}},
      plugins:{legend:{display:false}},
      datasets:{bar:{grouped:false,barPercentage:0.95,categoryPercentage:1.0}}
    }});

  function drawChart(saveReal, spendReal){
    bar.data.labels=[T.legSave, T.legSpend];
    bar.data.datasets=[
      {label:"Save",  data:[saveReal, null],  backgroundColor:"#ff9800"},
      {label:"Spend", data:[null, spendReal], backgroundColor:"#9e9e9e"}
    ];
    bar.update();
  }

  // WebR
  import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";
  const webr=new WebR();

  // helpers
  const unwrap = x => {
    if (x==null || typeof x!=="object") return x;
    if (x.type==="list"){ const o={}; (x.names||[]).forEach((k,i)=>o[k]=unwrap(x.values[i])); return o; }
    if (Array.isArray(x.values)) return x.values.length===1 ? unwrap(x.values[0]) : x.values.map(unwrap);
    return x;
  };
  const num = x => (typeof x==="number") ? x : (x && x.values ? x.values[0] : Array.isArray(x) ? x[0] : NaN);

  async function init(){
    await webr.init();
    const code=await (await fetch("./r/ucase8.R")).text();
    await webr.evalR(code);
  }

  async function compute(){
    try{
      refresh();
      const p=+pmtEl.value, ns=parseInt(nSaveEl.value,10), np=parseInt(nSpendEl.value,10),
            r=+rateEl.value, i=+inflEl.value;
      const res=await webr.evalR(`
        out <- ucase8(pmt_real_save=${p}, nper_save=${ns}, nper_spend=${np},
                      rate=${r}, inflation=${i})
        out
      `);
      let js=await res.toJs(); if(js && js.type) js=unwrap(js);
      const R = js.results || {};

      const spendReal = num(R.spend_real_during_retirement);
      const fvReal    = num(R.fv_real_at_retirement);

      // unterhalb ausgeben
      fvOut.textContent    = fmt(fvReal,{maximumFractionDigits:2});
      spendOut.textContent = fmt(spendReal,{maximumFractionDigits:2});

      // Chart (linke Säule = Sparrate, rechte = mögliche Ausgaben)
      drawChart(p, spendReal);

      if (debug) log(js);
    }catch(e){ if (debug) log("Compute error: "+(e?.message||e)); }
  }

  document.getElementById("compute").addEventListener("click", compute);
  [pmtEl,nSaveEl,nSpendEl,rateEl,inflEl].forEach(el=>el.addEventListener("input", compute));

  await init(); await compute();
</script>
</body>
</html>
